module AgentRuntime
  VERSION: String

  class Error < StandardError
  end

  class PolicyViolation < Error
  end

  class UnknownAction < Error
  end

  class ToolNotFound < Error
  end

  class ExecutionError < Error
  end

  class MaxIterationsExceeded < ExecutionError
  end

  Decision: singleton(Struct.new(:action, :params, :confidence, keyword_init: true))

  class State
    def initialize: (?Hash[untyped, untyped] data) -> void
    def snapshot: () -> Hash[untyped, untyped]
    def apply!: (Hash[untyped, untyped] result) -> void
  end

  class ToolRegistry
    def initialize: (?Hash[String, Proc] tools) -> void
    def call: (String action, Hash[untyped, untyped] params) -> untyped
  end

  class Planner
    def initialize: (untyped client, Hash[untyped, untyped] schema, Proc prompt_builder) -> void
    def plan: (String input:, Hash[untyped, untyped] state:) -> Decision
  end

  class Policy
    def initialize: () -> void
    def validate!: (Decision decision, State state:) -> void
  end

  class Executor
    def initialize: (ToolRegistry tool_registry:) -> void
    def execute: (Decision decision, State state:) -> Hash[untyped, untyped]
  end

  class AuditLog
    def record: (String input:, Decision decision, Hash[untyped, untyped] result:) -> void
  end

  class Agent
    def initialize: (Planner planner:, Policy policy:, Executor executor:, State state:, ?AuditLog audit_log, ?Integer max_iterations) -> void
    def step: (String input:) -> Hash[untyped, untyped]
    def run: (String initial_input:, ?Proc input_builder) -> Hash[untyped, untyped]
  end
end
