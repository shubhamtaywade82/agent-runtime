module AgentRuntime
  VERSION: String

  class Error < StandardError
  end

  class PolicyViolation < Error
  end

  class UnknownAction < Error
  end

  class ToolNotFound < Error
  end

  class ExecutionError < Error
  end

  class MaxIterationsExceeded < ExecutionError
  end

  Decision: singleton(Struct.new(:action, :params, :confidence, keyword_init: true))

  class State
    def initialize: (?Hash[untyped, untyped] data) -> void
    def snapshot: () -> Hash[untyped, untyped]
    def apply!: (Hash[untyped, untyped] result) -> void
  end

  class ToolRegistry
    def initialize: (?Hash[String, Proc] tools) -> void
    def call: (String action, Hash[untyped, untyped] params) -> untyped
  end

  class Planner
    def initialize: (untyped client, ?Hash[untyped, untyped] schema, ?Proc prompt_builder) -> void
    def plan: (String input:, Hash[untyped, untyped] state:) -> Decision
    def chat: (Array[Hash[untyped, untyped]] messages:, ?untyped tools, **untyped) -> Hash[untyped, untyped]
    def chat_raw: (Array[Hash[untyped, untyped]] messages:, ?untyped tools, **untyped) -> Hash[untyped, untyped]
  end

  class Policy
    def initialize: () -> void
    def validate!: (Decision decision, State state:) -> void
  end

  class Executor
    def initialize: (ToolRegistry tool_registry:) -> void
    def execute: (Decision decision, State state:) -> Hash[untyped, untyped]
  end

  class AuditLog
    def record: (String input:, Decision decision, Hash[untyped, untyped] result:) -> void
  end

  class Agent
    def initialize: (Planner planner:, Policy policy:, Executor executor:, State state:, ?AuditLog audit_log, ?Integer max_iterations) -> void
    def step: (String input:) -> Hash[untyped, untyped]
    def run: (String initial_input:, ?Proc input_builder) -> Hash[untyped, untyped]
  end

  class FSM
    def initialize: (?Integer max_iterations) -> void
    def state: () -> Integer
    def iteration_count: () -> Integer
    def history: () -> Array[Hash[untyped, untyped]]
    def intake?: () -> bool
    def plan?: () -> bool
    def decide?: () -> bool
    def execute?: () -> bool
    def observe?: () -> bool
    def loop_check?: () -> bool
    def finalize?: () -> bool
    def halt?: () -> bool
    def terminal?: () -> bool
    def transition_to: (Integer new_state, ?String reason) -> void
    def increment_iteration: () -> void
    def reset: () -> void
    def state_name: () -> Symbol
  end

  class AgentFSM
    def initialize: (Planner planner:, Policy policy:, Executor executor:, State state:, ToolRegistry tool_registry:, ?AuditLog audit_log, ?Integer max_iterations) -> void
    def run: (String initial_input:) -> Hash[untyped, untyped]
    def fsm: () -> FSM
    def messages: () -> Array[Hash[untyped, untyped]]
    def plan: () -> Hash[untyped, untyped]?
    def decision: () -> Hash[untyped, untyped]?
  end
end
